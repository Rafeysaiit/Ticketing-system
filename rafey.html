<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ticketing System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #eee;
    }
    #ticketModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.4);
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    #modalContent {
      background-color: white;
      padding: 20px;
      width: 500px;
      border-radius: 4px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input[type=text], input[type=date], select, textarea {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    button {
      margin-top: 15px;
      padding: 10px 15px;
      cursor: pointer;
    }
    #attachmentPreview {
      margin-top: 10px;
      max-width: 100%;
      max-height: 150px;
      display: block;
    }
  </style>
</head>
<body>

  <h1>Ticketing System</h1>

  <button onclick="openModal()">Add Ticket</button>

  <table id="ticketTable">
    <thead>
      <tr>
        <th>Dashboard Name</th>
        <th>Ticket No</th>
        <th>Stream</th>
        <th>Raised By</th>
        <th>Subject</th>
        <th>Date Logged</th>
        <th>Closed Date</th>
        <th>Priority</th>
        <th>Status</th>
        <th>Assigned To</th>
        <th>Description</th>
        <th>Attachment</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <!-- Ticket rows go here -->
    </tbody>
  </table>

  <!-- Modal -->
  <div id="ticketModal">
    <div id="modalContent">
      <h2 id="modalTitle">Add Ticket</h2>
      <form id="ticketForm" onsubmit="return saveTicket(event)">
        <label for="modalStream">Stream</label>
        <select id="modalStream" required onchange="populateDashboardOptions()">
          <option value="">Select Stream</option>
          <option value="Finance">Finance</option>
          <option value="Operations">Operations</option>
          <option value="HR">HR</option>
          <option value="Sales">Sales</option>
          <!-- Add other streams as needed -->
        </select>

        <label for="modalDashboard">Dashboard Name</label>
        <select id="modalDashboard" required>
          <option value="">Select Dashboard</option>
          <!-- Populated dynamically -->
        </select>

        <label for="modalTicketNo">Ticket No</label>
        <input type="text" id="modalTicketNo" required />

        <label for="modalRaisedBy">Raised By</label>
        <input type="text" id="modalRaisedBy" required />

        <label for="modalSubject">Subject</label>
        <select id="modalSubject" required onchange="autoSetPriority()">
          <option value="">Select Subject</option>
          <option value="Dashboard completely down">Dashboard completely down</option>
          <option value="data breach">data breach</option>
          <option value="Impact on CXO">Impact on CXO</option>
          <option value="Visual issues">Visual issues</option>
          <option value="incorrect data">incorrect data</option>
          <option value="Enhancement requests">Enhancement requests</option>
          <option value="UI tweaks">UI tweaks</option>
          <option value="training queries">training queries</option>
          <option value="Technical support">Technical support</option>
          <option value="New dashboard Request">New dashboard Request</option>
          <option value="Other">Other</option>
        </select>

        <label for="modalDateLogged">Date Logged</label>
        <input type="date" id="modalDateLogged" required />

        <label for="modalClosedDate">Closed Date</label>
        <input type="date" id="modalClosedDate" disabled />

        <label for="modalPriority">Priority</label>
        <select id="modalPriority" required>
          <option value="">Select Priority</option>
          <option value="High">High</option>
          <option value="Medium">Medium</option>
          <option value="Low">Low</option>
        </select>

        <label for="modalStatus">Status</label>
        <select id="modalStatus" required onchange="handleStatusChange()">
          <option value="">Select Status</option>
          <option value="Open">Open</option>
          <option value="In Progress">In Progress</option>
          <option value="Closed">Closed</option>
          <option value="Reopened">Reopened</option>
        </select>

        <label for="modalAssignedTo">Assigned To</label>
        <input type="text" id="modalAssignedTo" readonly />

        <label for="modalDescription">Description</label>
        <textarea id="modalDescription"></textarea>

        <label for="modalAttachment">Attachment (Image)</label>
        <input type="file" id="modalAttachment" accept="image/*" onchange="previewAttachment(event)" />
        <img id="attachmentPreview" src="" alt="Attachment Preview" style="display:none;" />

        <button type="submit">Save</button>
        <button type="button" onclick="closeModal()">Cancel</button>
      </form>
    </div>
  </div>

  <script>
    let editingRow = null;
    let currentAttachmentBase64 = "";

    const dashboardOptions = {
      Finance: [
        "All",
        "Master Matrics",
        "MIS P&L Analytics",
        "P&L Analytics MOM",
        "Revenue Analysis",
        "Revenue Analysis-BreakDown",
        "Revenue Details Table",
        "Revenue Waterfall Journey",
        "Direct",
      ],
      Operations: [
        "Logistics Dashboard",
        "Operations Report",
        "Process Improvement",
      ],
      HR: [
        "Employee Dashboard",
        "Recruitment Report",
        "Training Overview",
      ],
      Sales: [
        "Sales Performance",
        "Customer Analytics",
        "Sales Pipeline",
      ],
    };

    function openModal() {
      document.getElementById("ticketModal").style.display = "flex";
      document.getElementById("ticketForm").reset();
      currentAttachmentBase64 = "";
      editingRow = null;
      document.getElementById("modalTicketNo").readOnly = false;
      document.getElementById("modalDashboard").innerHTML = '<option value="">Select Dashboard</option>';
      document.getElementById("modalTitle").textContent = "Add Ticket";
      document.getElementById("modalClosedDate").disabled = true;
      document.getElementById("modalAssignedTo").value = "";
      document.getElementById("attachmentPreview").style.display = "none";
      document.getElementById("attachmentPreview").src = "";

      // Auto assign "Assigned To" same as Raised By when Raised By changes
      document.getElementById("modalRaisedBy").onchange = function () {
        document.getElementById("modalAssignedTo").value = this.value;
      };
    }

    function closeModal() {
      document.getElementById("ticketModal").style.display = "none";
    }

    function populateDashboardOptions() {
      const stream = document.getElementById("modalStream").value;
      const dashboardSelect = document.getElementById("modalDashboard");
      dashboardSelect.innerHTML = '<option value="">Select Dashboard</option>';
      if (dashboardOptions[stream]) {
        dashboardOptions[stream].forEach((dash) => {
          const option = document.createElement("option");
          option.value = dash;
          option.textContent = dash;
          dashboardSelect.appendChild(option);
        });
      }
    }

    function autoSetPriority() {
      const subject = document.getElementById("modalSubject").value;
      const prioritySelect = document.getElementById("modalPriority");
      if (
        subject === "Dashboard completely down" ||
        subject === "data breach" ||
        subject === "Impact on CXO"
      ) {
        prioritySelect.value = "High";
      } else if (
        subject === "Visual issues" ||
        subject === "incorrect data"
      ) {
        prioritySelect.value = "Medium";
      } else if (
        subject === "Enhancement requests" ||
        subject === "UI tweaks" ||
        subject === "training queries" ||
        subject === "Technical support" ||
        subject === "New dashboard Request" ||
        subject === "Other"
      ) {
        prioritySelect.value = "Low";
      } else {
        prioritySelect.value = "";
      }
    }

    function handleStatusChange() {
      const status = document.getElementById("modalStatus").value;
      const closedDateInput = document.getElementById("modalClosedDate");

      if (status === "Closed") {
        closedDateInput.disabled = false;
        if (!closedDateInput.value) {
          const today = new Date().toISOString().split("T")[0];
          closedDateInput.value = today;
        }
      } else {
        closedDateInput.value = "";
        closedDateInput.disabled = true;
      }
    }

    function previewAttachment(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          currentAttachmentBase64 = e.target.result;
          const preview = document.getElementById("attachmentPreview");
          preview.src = currentAttachmentBase64;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        currentAttachmentBase64 = "";
        const preview = document.getElementById("attachmentPreview");
        preview.src = "";
        preview.style.display = "none";
      }
    }

    function saveTicket(event) {
      event.preventDefault();

      const stream = document.getElementById("modalStream").value.trim();
      const dashboard = document.getElementById("modalDashboard").value.trim();
      const ticketNo = document.getElementById("modalTicketNo").value.trim();
      const raisedBy = document.getElementById("modalRaisedBy").value.trim();
      const subject = document.getElementById("modalSubject").value.trim();
      const dateLogged = document.getElementById("modalDateLogged").value;
      const closedDate = document.getElementById("modalClosedDate").value;
      const priority = document.getElementById("modalPriority").value;
      const status = document.getElementById("modalStatus").value;
      const assignedTo = document.getElementById("modalAssignedTo").value.trim();
      const description = document.getElementById("modalDescription").value.trim();

      if (!stream || !dashboard || !ticketNo || !raisedBy || !subject || !dateLogged || !priority || !status) {
        alert("Please fill all required fields.");
        return false;
      }

      // If adding new ticket, check if ticketNo already exists
      if (!editingRow) {
        const existingRow = Array.from(document.querySelectorAll("#ticketTable tbody tr")).find(row => row.cells[1].innerText === ticketNo);
        if (existingRow) {
          alert("Ticket No already exists.");
          return false;
        }
      }

      const tbody = document.querySelector("#ticketTable tbody");

      if (editingRow) {
        // Update existing row
        const cells = editingRow.cells;
        cells[0].innerText = dashboard;
        cells[1].innerText = ticketNo;
        cells[2].innerText = stream;
        cells[3].innerText = raisedBy;
        cells[4].innerText = subject;
        cells[5].innerText = dateLogged;
        cells[6].innerText = closedDate;
        cells[7].innerText = priority;
        cells[8].innerText = status;
        cells[9].innerText = assignedTo;
        cells[10].innerText = description;

        // Update attachment
        const img = cells[11].querySelector("img");
        if (currentAttachmentBase64) {
          if (img) {
            img.src = currentAttachmentBase64;
          } else {
            const newImg = document.createElement("img");
            newImg.src = currentAttachmentBase64;
            newImg.style.maxWidth = "100px";
            newImg.style.maxHeight = "80px";
            cells[11].appendChild(newImg);
          }
        } else {
          if (img) {
            img.remove();
          }
        }

      } else {
        // Add new row
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${dashboard}</td>
          <td>${ticketNo}</td>
          <td>${stream}</td>
          <td>${raisedBy}</td>
          <td>${subject}</td>
          <td>${dateLogged}</td>
          <td>${closedDate}</td>
          <td>${priority}</td>
          <td>${status}</td>
          <td>${assignedTo}</td>
          <td>${description}</td>
          <td></td>
          <td><button type="button" onclick="editRow(this)">Edit</button></td>
        `;

        if (currentAttachmentBase64) {
          const img = document.createElement("img");
          img.src = currentAttachmentBase64;
          img.style.maxWidth = "100px";
          img.style.maxHeight = "80px";
          tr.cells[11].appendChild(img);
        }

        tbody.appendChild(tr);
      }

      closeModal();
      return false;
    }

    function editRow(button) {
      editingRow = button.closest("tr");
      const cells = editingRow.querySelectorAll("td");

      document.getElementById("modalTitle").textContent = "Edit Ticket";

      document.getElementById("modalStream").value = cells[2].innerText;
      populateDashboardOptions();
      document.getElementById("modalDashboard").value = cells[0].innerText;
      document.getElementById("modalTicketNo").value = cells[1].innerText;
      document.getElementById("modalTicketNo").readOnly = true;
      document.getElementById("modalRaisedBy").value = cells[3].innerText;
      document.getElementById("modalSubject").value = cells[4].innerText;
      document.getElementById("modalDateLogged").value = cells[5].innerText;
      document.getElementById("modalClosedDate").value = cells[6].innerText;
      document.getElementById("modalPriority").value = cells[7].innerText.trim();
      document.getElementById("modalStatus").value = cells[8].innerText;
      document.getElementById("modalAssignedTo").value = cells[9].innerText;
      document.getElementById("modalDescription").value = cells[10].innerText;

      currentAttachmentBase64 = cells[11].querySelector("img")?.src || "";

      const preview = document.getElementById("attachmentPreview");
      if (currentAttachmentBase64) {
        preview.src = currentAttachmentBase64;
        preview.style.display = "block";
      } else {
        preview.src = "";
        preview.style.display = "none";
      }

      handleStatusChange();

      // On edit, disable Assigned To input so it stays readonly
      document.getElementById("modalAssignedTo").readOnly = true;

      // Remove auto assign on Raised By change (not applicable on edit)
      document.getElementById("modalRaisedBy").onchange = null;

      document.getElementById("ticketModal").style.display = "flex";
    }
  </script>

</body>
</html>
